# Module 09: Booking Management (Partner Portal)

## Screens

| Screen | Route | Mô t? |
|--------|-------|-------|
| Bookings List | `/manage/bookings` | Danh sách t?t c? bookings |
| Booking Detail | `/manage/bookings/[id]` | Chi ti?t booking |
| Today's Arrivals | `/manage/bookings/arrivals` | Check-in hôm nay |
| Today's Departures | `/manage/bookings/departures` | Check-out hôm nay |
| Create Booking | `/manage/bookings/new` | T?o booking m?i (walk-in) |

---

## API Endpoints

### 1. Get Hotel Bookings
```http
GET /api/hotels/{hotelId}/bookings
Authorization: Bearer {token}
```

**Query Parameters:**
| Param | Type | Default | Mô t? |
|-------|------|---------|-------|
| `status` | string | - | `Pending`, `Confirmed`, `CheckedIn`, etc. |
| `fromDate` | date | - | Filter from date |
| `toDate` | date | - | Filter to date |
| `search` | string | - | Search by guest name or confirmation # |
| `page` | int | 1 | |
| `pageSize` | int | 20 | |

**Response:**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "confirmationNumber": "BK-20240201-ABC123",
        "status": "Confirmed",
        "guestName": "John Doe",
        "guestEmail": "john@example.com",
        "guestPhoneNumber": "+84901234567",
        "checkInDate": "2024-02-01T14:00:00Z",
        "checkOutDate": "2024-02-03T12:00:00Z",
        "numberOfGuests": 2,
        "numberOfRooms": 1,
        "rooms": [
          { "roomNumber": "301", "roomType": "Deluxe King" }
        ],
        "totalAmount": 6850000,
        "isPaid": true,
        "source": "Website",
        "createdAt": "2024-01-20T10:00:00Z"
      }
    ],
    "totalCount": 150,
    "summary": {
      "totalBookings": 150,
      "pendingCount": 5,
      "confirmedCount": 120,
      "checkedInCount": 15,
      "cancelledCount": 10
    }
  }
}
```

---

### 2. Get Today's Arrivals
```http
GET /api/hotels/{hotelId}/bookings/arrivals
Authorization: Bearer {token}
```

**Query Parameters:**
| Param | Type | Default |
|-------|------|---------|
| `date` | date | today |

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "confirmationNumber": "BK-20240201-ABC123",
      "status": "Confirmed",
      "guestName": "John Doe",
      "guestPhoneNumber": "+84901234567",
      "checkInDate": "2024-02-01T14:00:00Z",
      "checkOutDate": "2024-02-03T12:00:00Z",
      "expectedArrivalTime": "15:00",
      "rooms": [
        { "roomNumber": "301", "roomType": "Deluxe King" }
      ],
      "specialRequests": "Late check-in around 10pm",
      "isPaid": true,
      "isVIP": false
    }
  ]
}
```

---

### 3. Get Today's Departures
```http
GET /api/hotels/{hotelId}/bookings/departures
Authorization: Bearer {token}
```

---

### 4. Get Booking Detail
```http
GET /api/bookings/{id}
Authorization: Bearer {token}
```

---

### 5. Check-In Guest
```http
POST /api/bookings/{id}/check-in
Authorization: Bearer {token}
```

**Request:**
```json
{
  "roomNumber": "301",
  "idDocumentType": "Passport",
  "idDocumentNumber": "C12345678",
  "notes": "Guest requested extra pillows"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Guest checked in successfully",
  "data": {
    "status": "CheckedIn",
    "checkedInAt": "2024-02-01T15:30:00Z",
    "checkedInBy": "Staff Name"
  }
}
```

---

### 6. Check-Out Guest
```http
POST /api/bookings/{id}/check-out
Authorization: Bearer {token}
```

**Request:**
```json
{
  "additionalCharges": [
    { "description": "Mini bar", "amount": 625000 },
    { "description": "Room service", "amount": 1125000 }
  ],
  "notes": "All good, guest satisfied"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Guest checked out successfully",
  "data": {
    "status": "CheckedOut",
    "checkedOutAt": "2024-02-03T11:00:00Z",
    "finalBill": {
      "roomCharges": 6850000,
      "additionalCharges": 1750000,
      "totalAmount": 8600000,
      "amountPaid": 6850000,
      "balanceDue": 1750000
    }
  }
}
```

---

### 7. Cancel Booking (by Hotel)
```http
POST /api/bookings/{id}/cancel
Authorization: Bearer {token}
```

**Request:**
```json
{
  "reason": "Guest requested cancellation",
  "refundAmount": 6850000,
  "isFullRefund": true
}
```

---

### 8. Modify Booking
```http
PUT /api/bookings/{id}
Authorization: Bearer {token}
```

**Request:**
```json
{
  "checkInDate": "2024-02-02T14:00:00Z",
  "checkOutDate": "2024-02-04T12:00:00Z",
  "rooms": [
    { "roomId": "uuid", "numberOfAdults": 2 }
  ],
  "specialRequests": "Updated request"
}
```

---

### 9. Change Room Assignment
```http
PUT /api/bookings/{id}/rooms
Authorization: Bearer {token}
```

**Request:**
```json
{
  "oldRoomId": "uuid-301",
  "newRoomId": "uuid-305",
  "reason": "Guest requested higher floor"
}
```

---

### 10. Create Walk-in Booking
```http
POST /api/hotels/{hotelId}/bookings
Authorization: Bearer {token}
```

**Request:**
```json
{
  "roomId": "uuid",
  "guestName": "Jane Smith",
  "guestEmail": "jane@example.com",
  "guestPhoneNumber": "+84901234567",
  "checkInDate": "2024-02-01T14:00:00Z",
  "checkOutDate": "2024-02-03T12:00:00Z",
  "numberOfAdults": 2,
  "numberOfChildren": 0,
  "paymentMethod": "Cash",
  "isPaid": true,
  "source": "WalkIn"
}
```

---

### 11. Add Booking Note
```http
POST /api/bookings/{id}/notes
Authorization: Bearer {token}
```

**Request:**
```json
{
  "content": "Guest called to confirm late arrival",
  "isInternal": true
}
```

---

### 12. Get Booking History/Timeline
```http
GET /api/bookings/{id}/timeline
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "timestamp": "2024-01-20T10:00:00Z",
      "action": "Created",
      "description": "Booking created via Website",
      "performedBy": "System"
    },
    {
      "timestamp": "2024-01-20T10:05:00Z",
      "action": "PaymentReceived",
      "description": "Payment of 6.850.000 VND received via Stripe",
      "performedBy": "System"
    },
    {
      "timestamp": "2024-02-01T15:30:00Z",
      "action": "CheckedIn",
      "description": "Guest checked in to Room 301",
      "performedBy": "Staff Name"
    }
  ]
}
```

---

## TypeScript Types

```typescript
interface BookingManagementDto {
  id: string;
  confirmationNumber: string;
  status: BookingStatus;
  guestName: string;
  guestEmail: string;
  guestPhoneNumber: string;
  checkInDate: string;
  checkOutDate: string;
  numberOfGuests: number;
  numberOfRooms: number;
  rooms: BookingRoomSummary[];
  totalAmount: number;
  isPaid: boolean;
  source: BookingSource;
  specialRequests?: string;
  createdAt: string;
}

interface BookingRoomSummary {
  roomId: string;
  roomNumber: string;
  roomType: string;
  guestName?: string;
}

enum BookingStatus {
  Pending = 0,
  Confirmed = 1,
  CheckedIn = 2,
  CheckedOut = 3,
  Cancelled = 4,
  NoShow = 5
}

enum BookingSource {
  Website = 0,
  Mobile = 1,
  WalkIn = 2,
  Phone = 3,
  OTA = 4,
  Corporate = 5
}

interface CheckInRequest {
  roomNumber?: string;
  idDocumentType?: string;
  idDocumentNumber?: string;
  notes?: string;
}

interface CheckOutRequest {
  additionalCharges?: AdditionalCharge[];
  notes?: string;
}

interface AdditionalCharge {
  description: string;
  amount: number;
}

interface BookingTimelineItem {
  timestamp: string;
  action: string;
  description: string;
  performedBy: string;
}

interface CreateWalkInBookingRequest {
  roomId: string;
  guestName: string;
  guestEmail?: string;
  guestPhoneNumber?: string;
  checkInDate: string;
  checkOutDate: string;
  numberOfAdults: number;
  numberOfChildren?: number;
  paymentMethod: string;
  isPaid: boolean;
  source: BookingSource;
}
```

---

## Screen Specifications

### Bookings List Screen
```
????????????????????????????????????????????????????
?  ?? Bookings                      [+ Walk-in]    ?
????????????????????????????????????????????????????
?  [All] [Pending 5] [Confirmed] [CheckedIn 15]    ?
?                                                  ?
?  ?? Search by guest name or confirmation #       ?
?  Date: [Feb 1] to [Feb 28]        [?? Filter]    ?
????????????????????????????????????????????????????
?  ??? Today's Overview ?????????????????????????  ?
?  ? 15 Arrivals ? 12 Departures ? 85 In-House ?  ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????????????? ?
?  ? BK-20240201-ABC123        ? Confirmed     ? ?
?  ? John Doe • +84901234567                   ? ?
?  ? Feb 1 - Feb 3 • Room 301 (Deluxe King)    ? ?
?  ? 2 guests • 6,850,000 VND ?? Paid          ? ?
?  ? ?????????????????????????????????????     ? ?
?  ? [View] [Check-In] [···]                   ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? BK-20240201-XYZ789        ? CheckedIn     ? ?
?  ? Jane Smith • +84901234567                 ? ?
?  ? Jan 30 - Feb 2 • Room 205 (Suite)         ? ?
?  ? 2 guests • 11,250,000 VND ?? Paid         ? ?
?  ? ?????????????????????????????????????     ? ?
?  ? [View] [Check-Out] [···]                  ? ?
?  ?????????????????????????????????????????????? ?
????????????????????????????????????????????????????

### Booking Detail Screen
```
????????????????????????????????????????????????????
?  ? Back     BK-20240201-ABC123     [Check-In]    ?
????????????????????????????????????????????????????
?                                                  ?
?  Status: ? Confirmed                             ?
?                                                  ?
?  ??? Guest Information ????????????????????????  ?
?  ?? John Doe                                     ?
?  ?? john@example.com                             ?
?  ?? +84 901 234 567                              ?
?  ?? Passport: C12345678                          ?
?                                                  ?
?  ??? Stay Details ?????????????????????????????  ?
?  ?? Check-in:  Thu, Feb 1, 2024 at 14:00        ?
?  ?? Check-out: Sat, Feb 3, 2024 at 12:00        ?
?  ?? 2 nights                                     ?
?                                                  ?
?  ??? Room Assignment ??????????????????????????  ?
?  ?????????????????????????????????????????????? ?
?  ? Room 301 - Deluxe King                     ? ?
?  ? ?? 2 Adults                                ? ?
?  ?                           [Change Room]    ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Special Requests ?????????????????????????  ?
?  Late check-in around 10pm                       ?
?  High floor if possible                          ?
?                                                  ?
?  ??? Payment ??????????????????????????????????  ?
?  Room charges:         7,500,000 VND             ?
?  Discount (SUMMER20): -1,500,000 VND             ?
?  Taxes & Fees:           850,000 VND             ?
?  ????????????????????????????????                ?
?  Total:                6,850,000 VND             ?
?  Paid via VNPay:       6,850,000 VND ?           ?
?  Balance:                      0 VND             ?
?                                                  ?
?  ??? Timeline ?????????????????????????????????  ?
?  • Jan 20, 10:00 - Booking created (Website)     ?
?  • Jan 20, 10:05 - Payment received (6.85M)      ?
?  • Jan 20, 10:05 - Confirmation email sent       ?
?                                                  ?
?  ??? Notes ?????????????????????? [+ Add Note]   ?
?  ?? Guest called to confirm late arrival         ?
?     - Staff Name, Jan 25, 14:00                  ?
?                                                  ?
????????????????????????????????????????????????????

### Check-In Modal
```
????????????????????????????????????????
?           Check-In Guest             ?
????????????????????????????????????????
?  Guest: John Doe                     ?
?  Booking: BK-20240201-ABC123         ?
?                                      ?
?  ??? Room Assignment ???????????????  ?
?  ??????????????????????????????????  ?
?  ? Room Number                    ?  ?
?  ? 301 (Deluxe King)           ?  ?  ?
?  ??????????????????????????????????  ?
?                                      ?
?  ??? ID Verification ???????????????  ?
?  ??????????????????????????????????  ?
?  ? Document Type                  ?  ?
?  ? Passport                    ?  ?  ?
?  ??????????????????????????????????  ?
?  ??????????????????????????????????  ?
?  ? Document Number                ?  ?
?  ? C12345678                      ?  ?
?  ??????????????????????????????????  ?
?                                      ?
?  ??? Notes ?????????????????????????  ?
?  ??????????????????????????????????  ?
?  ? Guest requested extra pillows  ?  ?
?  ??????????????????????????????????  ?
?                                      ?
?  ??????????????????????????????????  ?
?  ?        Complete Check-In       ?  ?
?  ??????????????????????????????????  ?
?  [Cancel]                            ?
????????????????????????????????????????
```

### Check-Out Modal
```
????????????????????????????????????????
?          Check-Out Guest             ?
????????????????????????????????????????
?  Guest: John Doe                     ?
?  Room: 301 • Feb 1-3, 2024           ?
?                                      ?
?  ??? Charges Summary ???????????????  ?
?  Room charges:        6,850,000 VND  ?
?  Already paid:        6,850,000 VND  ?
?                                      ?
?  ??? Additional Charges ?? [+ Add]   ?
?  ??????????????????????????????????  ?
?  ? Mini bar             625,000  ?  ?
?  ? Room service       1,125,000  ?  ?
?  ??????????????????????????????????  ?
?  Subtotal:            1,750,000      ?
?                                      ?
?  ??? Balance Due ???????????????????  ?
?  Total:               8,600,000      ?
?  Paid:                6,850,000      ?
?  ?????????????????????????????????   ?
?  Balance:             1,750,000      ?
?                                      ?
?  Payment Method: [Cash ?]            ?
?                                      ?
?  ??????????????????????????????????  ?
?  ?       Complete Check-Out       ?  ?
?  ??????????????????????????????????  ?
?  [Cancel]                            ?
????????????????????????????????????????

---
