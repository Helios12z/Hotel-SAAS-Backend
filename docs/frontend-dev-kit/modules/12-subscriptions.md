# Module 12: Subscriptions & Billing

## Screens

| Screen | Route | Mô t? |
|--------|-------|-------|
| Current Subscription | `/manage/subscription` | Gói hi?n t?i |
| Change Plan | `/manage/subscription/change` | ??i gói |
| Billing History | `/manage/subscription/billing` | L?ch s? thanh toán |
| Payment Methods | `/manage/subscription/payment-methods` | Qu?n lý thanh toán |

---

## API Endpoints

### 1. Get Current Subscription
```http
GET /api/subscriptions/current
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "plan": {
      "id": "uuid",
      "name": "Standard",
      "planType": "Standard",
      "monthlyPrice": 2499000,
      "maxHotels": 3,
      "maxRoomsPerHotel": 100,
      "maxUsersPerHotel": 10,
      "commissionRate": 15,
      "hasAnalytics": true,
      "hasAdvancedReporting": false,
      "hasApiAccess": false,
      "hasPrioritySupport": true,
      "hasChannelManager": false,
      "hasRevenueManagement": false,
      "hasMultiLanguage": true,
      "hasCustomBranding": false,
      "hasDedicatedAccountManager": false
    },
    "status": "Active",
    "billingCycle": "Monthly",
    "price": 2499000,
    "currency": "VND",
    "startDate": "2024-02-01T00:00:00Z",
    "endDate": "2024-02-29T23:59:59Z",
    "nextBillingDate": "2024-03-01T00:00:00Z",
    "autoRenew": true,
    "trialEndDate": null
  }
}
```

---

### 2. Get Subscription Plans
```http
GET /api/subscription-plans
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "name": "Basic",
      "description": "Dành cho khách s?n nh? m?i b?t ??u",
      "planType": "Basic",
      "monthlyPrice": 1249000,
      "quarterlyPrice": 3372000,
      "yearlyPrice": 11990000,
      "currency": "VND",
      "maxHotels": 1,
      "maxRoomsPerHotel": 30,
      "maxUsersPerHotel": 3,
      "commissionRate": 18,
      "hasAnalytics": false,
      "hasAdvancedReporting": false,
      "hasApiAccess": false,
      "hasPrioritySupport": false,
      "hasChannelManager": false,
      "hasRevenueManagement": false,
      "hasMultiLanguage": false,
      "hasCustomBranding": false,
      "hasDedicatedAccountManager": false,
      "trialDays": 14,
      "isActive": true,
      "isPopular": false,
      "sortOrder": 1
    },
    {
      "id": "uuid",
      "name": "Standard",
      "description": "Dành cho khách s?n ?ang phát tri?n",
      "planType": "Standard",
      "monthlyPrice": 2499000,
      "quarterlyPrice": 6747000,
      "yearlyPrice": 23990000,
      "currency": "VND",
      "maxHotels": 3,
      "maxRoomsPerHotel": 100,
      "maxUsersPerHotel": 10,
      "commissionRate": 15,
      "hasAnalytics": true,
      "hasAdvancedReporting": false,
      "hasApiAccess": false,
      "hasPrioritySupport": true,
      "hasChannelManager": false,
      "hasRevenueManagement": false,
      "hasMultiLanguage": true,
      "hasCustomBranding": false,
      "hasDedicatedAccountManager": false,
      "trialDays": 14,
      "isActive": true,
      "isPopular": true,
      "sortOrder": 2
    },
    {
      "id": "uuid",
      "name": "Premium",
      "description": "Dành cho khách s?n l?n v?i ??y ?? tính n?ng",
      "planType": "Premium",
      "monthlyPrice": 4999000,
      "quarterlyPrice": 13497000,
      "yearlyPrice": 47990000,
      "currency": "VND",
      "maxHotels": 10,
      "maxRoomsPerHotel": 500,
      "maxUsersPerHotel": 25,
      "commissionRate": 12,
      "hasAnalytics": true,
      "hasAdvancedReporting": true,
      "hasApiAccess": true,
      "hasPrioritySupport": true,
      "hasChannelManager": true,
      "hasRevenueManagement": true,
      "hasMultiLanguage": true,
      "hasCustomBranding": true,
      "hasDedicatedAccountManager": false,
      "trialDays": 30,
      "isActive": true,
      "isPopular": false,
      "sortOrder": 3
    }
  ]
}
```

---

### 3. Create/Change Subscription
```http
POST /api/subscriptions
Authorization: Bearer {token}
```

**Request:**
```json
{
  "brandId": "uuid",
  "planId": "uuid",
  "billingCycle": "Monthly",
  "autoRenew": true
}
```

---

### 4. Cancel Subscription
```http
POST /api/subscriptions/{id}/cancel
Authorization: Bearer {token}
```

**Request:**
```json
{
  "reason": "?óng c?a kinh doanh",
  "cancelImmediately": false
}
```

**Response:**
```json
{
  "success": true,
  "message": "Subscription s? b? h?y vào cu?i k? thanh toán",
  "data": {
    "cancellationDate": "2024-02-29T23:59:59Z"
  }
}
```

---

### 5. Get Invoices
```http
GET /api/subscriptions/{id}/invoices
Authorization: Bearer {token}
```

**Query Parameters:**
| Param | Type | Default |
|-------|------|---------|
| `page` | int | 1 |
| `pageSize` | int | 10 |

**Response:**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "invoiceNumber": "INV-2024-0001",
        "periodStart": "2024-02-01",
        "periodEnd": "2024-02-29",
        "subtotal": 2499000,
        "discountAmount": 0,
        "taxAmount": 249900,
        "totalAmount": 2748900,
        "currency": "VND",
        "status": "Paid",
        "dueDate": "2024-02-01",
        "paidAt": "2024-02-01T10:00:00Z",
        "invoicePdfUrl": "https://...",
        "createdAt": "2024-02-01T00:00:00Z"
      }
    ],
    "totalCount": 12
  }
}
```

---

### 6. Download Invoice PDF
```http
GET /api/subscriptions/invoices/{id}/download
Authorization: Bearer {token}
```

---

### 7. Get Usage Statistics
```http
GET /api/subscriptions/current/usage
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "plan": {
      "maxHotels": 3,
      "maxRoomsPerHotel": 100,
      "maxUsersPerHotel": 10
    },
    "usage": {
      "hotels": {
        "used": 2,
        "limit": 3,
        "percentage": 66.7
      },
      "rooms": {
        "used": 65,
        "limit": 100,
        "percentage": 65.0
      },
      "users": {
        "used": 5,
        "limit": 10,
        "percentage": 50.0
      }
    }
  }
}
```

---

## Screen Specifications

### Current Subscription Screen
```
????????????????????????????????????????????????????
?  ?? Subscription                                 ?
????????????????????????????????????????????????????
?                                                  ?
?  ??? Gói hi?n t?i ?????????????????????????????  ?
?  ?????????????????????????????????????????????? ?
?  ?                                            ? ?
?  ?   STANDARD                    ? Ho?t ??ng  ? ?
?  ?   2,499,000 VND/tháng                      ? ?
?  ?                                            ? ?
?  ?   Thanh toán ti?p: 01/03/2024              ? ?
?  ?   S? ti?n: 2,499,000 VND                   ? ?
?  ?                                            ? ?
?  ?   [??i gói]  [H?y subscription]            ? ?
?  ?                                            ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? S? d?ng ??????????????????????????????????  ?
?  ?????????????????????????????????????????????? ?
?  ? Khách s?n        ???????????? 2/3  (67%)   ? ?
?  ? Phòng/KS         ???????????? 65/100 (65%) ? ?
?  ? Ng??i dùng/KS    ???????????? 5/10  (50%)  ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Tính n?ng ????????????????????????????????  ?
?  ? Analytics & Reporting                        ?
?  ? H? tr? ?u tiên                               ?
?  ? ?a ngôn ng?                                  ?
?  ? API Access (Premium)                         ?
?  ? Channel Manager (Premium)                    ?
?  ? Revenue Management (Premium)                 ?
?                                                  ?
?  ??? L?ch s? thanh toán ????? [Xem t?t c? ?]???  ?
?  ? 01/02/2024 ? INV-0002 ? 2,499,000 VND ? Paid? ?
?  ? 01/01/2024 ? INV-0001 ? 2,499,000 VND ? Paid? ?
?                                                  ?
????????????????????????????????????????????????????
```

### Change Plan Screen
```
????????????????????????????????????????????????????????????????????????
?  ? Quay l?i              ??i gói                                     ?
????????????????????????????????????????????????????????????????????????
?  Gói hi?n t?i: Standard (2,499,000 VND/tháng)                       ?
?                                                                      ?
?  Chu k?: [? Hàng tháng  ? Hàng quý -10%  ? Hàng n?m -20%]          ?
?                                                                      ?
?  ???????????????????? ???????????????????? ????????????????????     ?
?  ?     Basic        ? ?    Standard      ? ?    Premium       ?     ?
?  ?                  ? ?   ? Hi?n t?i     ? ?   ? Ph? bi?n     ?     ?
?  ?  1,249,000/th    ? ?  2,499,000/th    ? ?  4,999,000/th    ?     ?
?  ?                  ? ?                  ? ?                  ?     ?
?  ?  ? 1 Khách s?n   ? ?  ? 3 Khách s?n   ? ?  ? 10 Khách s?n  ?     ?
?  ?  ? 30 Phòng      ? ?  ? 100 Phòng     ? ?  ? 500 Phòng     ?     ?
?  ?  ? 3 Users       ? ?  ? 10 Users      ? ?  ? 25 Users      ?     ?
?  ?  18% hoa h?ng    ? ?  15% hoa h?ng    ? ?  12% hoa h?ng    ?     ?
?  ?                  ? ?                  ? ?  ? T?t c? tính n?ng?   ?
?  ?                  ? ?                  ? ?                  ?     ?
?  ?  [H? c?p]        ? ?   Gói hi?n t?i   ? ?    [Nâng c?p]    ?     ?
?  ???????????????????? ???????????????????? ????????????????????     ?
?                                                                      ?
?  ?? H? c?p xu?ng Basic s? gi?m gi?i h?n khách s?n t? 3 xu?ng 1.     ?
?     B?n hi?n có 2 khách s?n.                                         ?
?                                                                      ?
????????????????????????????????????????????????????????????????????????
```

### Billing History Screen
```
????????????????????????????????????????????????????
?  ? Quay l?i       L?ch s? thanh toán             ?
????????????????????????????????????????????????????
?                                                  ?
?  ?????????????????????????????????????????????? ?
?  ? INV-2024-0002                              ? ?
?  ? 01/02/2024                                 ? ?
?  ? Standard Plan - Hàng tháng                 ? ?
?  ? ?????????????????????????????????????      ? ?
?  ? 2,499,000 VND                 ? ?ã thanh toán? ?
?  ?                          [?? T?i xu?ng]    ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? INV-2024-0001                              ? ?
?  ? 01/01/2024                                 ? ?
?  ? Standard Plan - Hàng tháng                 ? ?
?  ? ?????????????????????????????????????      ? ?
?  ? 2,499,000 VND                 ? ?ã thanh toán? ?
?  ?                          [?? T?i xu?ng]    ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
????????????????????????????????????????????????????
```

### Cancel Subscription Modal
```
????????????????????????????????????????
?        H?y Subscription?             ?
????????????????????????????????????????
?                                      ?
?  Chúng tôi r?t ti?c! ??              ?
?                                      ?
?  Subscription c?a b?n s? còn         ?
?  hi?u l?c ??n 29/02/2024.            ?
?                                      ?
?  ??? Lý do ?????????????????????????  ?
?  ??????????????????????????????????  ?
?  ? Ch?n lý do...               ?  ?  ?
?  ? ? Quá ??t                      ?  ?
?  ? ? Thi?u tính n?ng              ?  ?
?  ? ? Chuy?n sang ??i th?          ?  ?
?  ? ? ?óng c?a kinh doanh          ?  ?
?  ? ? Khác                         ?  ?
?  ??????????????????????????????????  ?
?                                      ?
?  ??? Góp ý (Tùy ch?n) ??????????????  ?
?  ??????????????????????????????????  ?
?  ? Cho chúng tôi bi?t cách c?i   ?  ?
?  ? thi?n...                       ?  ?
?  ??????????????????????????????????  ?
?                                      ?
?  ? H?y ngay l?p t?c (không hoàn ti?n)?
?                                      ?
?  ??????????????????????????????????  ?
?  ?      Xác nh?n h?y              ?  ?
?  ??????????????????????????????????  ?
?  [Gi? subscription]                  ?
????????????????????????????????????????
```

---

## Billing Cycle Discounts

| Cycle | Discount | Mô t? |
|-------|----------|-------|
| Monthly | 0% | Thanh toán hàng tháng |
| Quarterly | 10% | Thanh toán 3 tháng |
| Yearly | 20% | Thanh toán n?m |

---

## TypeScript Types

```typescript
interface SubscriptionDto {
  id: string;
  plan: SubscriptionPlanDto;
  status: SubscriptionStatus;
  billingCycle: BillingCycle;
  price: number;
  currency: string;
  startDate: string;
  endDate: string;
  nextBillingDate?: string;
  autoRenew: boolean;
  trialEndDate?: string;
}

interface SubscriptionPlanDto {
  id: string;
  name: string;
  description?: string;
  planType: SubscriptionPlanType;
  monthlyPrice: number;
  quarterlyPrice: number;
  yearlyPrice: number;
  currency: string;
  maxHotels: number;
  maxRoomsPerHotel: number;
  maxUsersPerHotel: number;
  commissionRate: number;
  hasAnalytics: boolean;
  hasAdvancedReporting: boolean;
  hasApiAccess: boolean;
  hasPrioritySupport: boolean;
  hasChannelManager: boolean;
  hasRevenueManagement: boolean;
  hasMultiLanguage: boolean;
  hasCustomBranding: boolean;
  hasDedicatedAccountManager: boolean;
  trialDays: number;
  isActive: boolean;
  isPopular: boolean;
  sortOrder: number;
}

enum SubscriptionStatus {
  Active = 0,
  Cancelled = 1,
  Expired = 2,
  PastDue = 3,
  Trialing = 4,
  Paused = 5
}

enum SubscriptionPlanType {
  Basic = 0,
  Standard = 1,
  Premium = 2,
  Enterprise = 3
}

enum BillingCycle {
  Monthly = 0,
  Quarterly = 1,
  Yearly = 2
}

interface InvoiceDto {
  id: string;
  invoiceNumber: string;
  periodStart: string;
  periodEnd: string;
  subtotal: number;
  discountAmount: number;
  taxAmount: number;
  totalAmount: number;
  currency: string;
  status: InvoiceStatus;
  dueDate: string;
  paidAt?: string;
  invoicePdfUrl?: string;
  createdAt: string;
}

enum InvoiceStatus {
  Draft = 0,
  Pending = 1,
  Paid = 2,
  Overdue = 3,
  Cancelled = 4
}
